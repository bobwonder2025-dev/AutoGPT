name: macOS Full UI Remote Access - Run #23 - GUARANTEED

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-13
    timeout-minutes: 360

    steps:
      - name: Enable SSH
        run: |
          sudo systemsetup -setremotelogin on
          echo "SSH enabled"
          
      - name: Enable Screen Sharing
        run: |
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -configure -access -on -users _www -privs -all -restart -agent -console
          defaults write /Library/Preferences/com.apple.RemoteManagement VNCLegacy -bool true
          echo "Screen Sharing enabled"
          
      - name: Grant Screen Recording Permissions
        run: |
          sqlite3 ~/Library/Application\ Support/CrashReporter/DiagnosticMessagesHistory.db "INSERT OR IGNORE INTO access VALUES('kTCCServiceScreenCapture','com.apple.systemevents',0,1,1,NULL,NULL,'UNUSED',NULL,0,NULL)"
          echo "Screen recording permissions granted"
          
      - name: Install Tailscale
        run: |
          brew install tailscale
          sudo /opt/homebrew/bin/tailscaled &
          sleep 3
          sudo /opt/homebrew/bin/tailscale up --authkey=${{ secrets.TS_AUTH_KEY }} --accept-routes 2>&1 || true
          sleep 5
          echo "Tailscale installed and connected"
          
      - name: Display Connection Info
        run: |
          echo "=== REMOTE ACCESS READY ==="
          echo "Tailscale IP: $(tailscale ip -4)"
          echo "VNC Password: RemoteAccess2025!"
          echo "VNC Port: 5900"
          echo ""
          echo "From Windows:"
          echo "1. Download VNC Viewer"
          echo "2. Connect to: $(tailscale ip -4):5900"
          echo "3. Password: RemoteAccess2025!"
          
      - name: Keep System Alive (6 Hours)
        run: |
          for minute in {1..360}; do
            if ! pgrep -x "sshd" > /dev/null; then
              sudo launchctl load -w /System/Library/LaunchDaemons/ssh.plist 2>/dev/null || true
            fi
            if ! tailscale status > /dev/null 2>&1; then
              sudo /opt/homebrew/bin/tailscale up 2>/dev/null || true
            fi
            if [ $((minute % 5)) -eq 0 ]; then
              echo "[Minute $minute/360] SSH: $(pgrep -x 'sshd' > /dev/null && echo 'OK' || echo 'DOWN') | Tailscale: $(tailscale status > /dev/null 2>&1 && echo 'OK' || echo 'DOWN')"
            fi
            caffeinate -u -t 60 &
            sleep 60
          done
