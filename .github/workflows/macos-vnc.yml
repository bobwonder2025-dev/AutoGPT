name: macOS VNC - SSH Tunnel Method (Reliable)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-13
    timeout-minutes: 360

    steps:
      - name: Install Tailscale
        run: brew install tailscale

      - name: Start Tailscale
        run: |
          sudo brew services start tailscale
          sleep 5

      - name: Connect to Tailscale
        env:
          TS_AUTH_KEY: ${{ secrets.TS_AUTH_KEY }}
        run: sudo tailscale up --authkey=$TS_AUTH_KEY --accept-routes

      - name: Install SSH Server (Already Built-in macOS)
        run: |
          echo "macOS SSH server is already enabled"
          # Enable SSH if not already
          sudo launchctl load -w /System/Library/LaunchDaemons/ssh.plist 2>/dev/null || echo "SSH already enabled"
          sleep 2

      - name: Display Connection Instructions
        run: |
          TAILSCALE_IP=$(tailscale ip -4)
          
          echo ""
          echo "╔════════════════════════════════════════════════════════════════════╗"
          echo "║          ✓ SECURE REMOTE ACCESS VIA SSH TUNNEL + VNC               ║"
          echo "╚════════════════════════════════════════════════════════════════════╝"
          echo ""
          echo "METHOD 1: SSH Access (Most Secure)"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  Command: ssh runner@$TAILSCALE_IP"
          echo "  Login: runner (GitHub Actions user)"
          echo ""
          echo "METHOD 2: VNC via SSH Tunnel (Screen Sharing)"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  Step 1: Open Terminal and run:"
          echo "          ssh -L 5900:localhost:5900 runner@$TAILSCALE_IP"
          echo "  Step 2: In TightVNC Viewer, connect to:"
          echo "          localhost:5900"
          echo "  Step 3: Use macOS login credentials when prompted"
          echo ""
          echo "SERVER INFORMATION"
          echo "━━━━━━━━━━━━━━━━━"
          echo "  Tailscale IP: $TAILSCALE_IP"
          echo "  SSH Port: 22"
          echo "  VNC Port: 5900 (via SSH tunnel)"
          echo "  Server: macOS 13 (GitHub Actions)"
          echo ""
          echo "═══════════════════════════════════════════════════════════════════════"
          echo ""

      - name: Keep SSH/System Alive - 6 Hour Keep-Alive Loop
        run: |
          echo "Starting 6-hour system keep-alive loop..."
          echo "SSH server will remain active for remote access"
          for minute in {1..360}; do
            echo "[$minute/360] System alive - SSH accessible via $TAILSCALE_IP:22"
            sleep 60
          done
