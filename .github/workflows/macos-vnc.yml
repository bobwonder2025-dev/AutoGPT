name: macOS VNC Remote Access

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-13
    timeout-minutes: 360

    steps:
      - name: Install Tailscale
        run: brew install tailscale

      - name: Start Tailscale
        run: |
          sudo brew services start tailscale
          sleep 5

      - name: Connect to Tailscale
        env:
          TS_AUTH_KEY: ${{ secrets.TS_AUTH_KEY }}
        run: sudo tailscale up --authkey=$TS_AUTH_KEY --accept-routes

      - name: Enable ARD/VNC via Plist Configuration (DIRECT METHOD)
        run: |
          echo "====== ENABLING ARD VIA DIRECT PLIST MODIFICATION ======"
          
          # Step 1: Stop existing services
          echo "Stopping services..."
          sudo launchctl stop com.apple.RemoteManagement.Agent.launchd 2>/dev/null || true
          sudo launchctl unload /System/Library/LaunchDaemons/com.apple.RemoteManagement.launchd 2>/dev/null || true
          sleep 3
          
          # Step 2: Enable VNC directly via plist
          echo "Configuring ARD via plist..."
          ARD_PLIST="/Library/Preferences/com.apple.RemoteManagement.plist"
          
          # Write VNC configuration directly
          sudo defaults write "$ARD_PLIST" ARD_AllowRemoteAppleEvents -bool true
          sudo defaults write "$ARD_PLIST" VNCLegacyConnectionsEnabled -bool true
          sudo defaults write "$ARD_PLIST" VNCEnabled -bool true
          sudo defaults write "$ARD_PLIST" VNCNewPasswordSet -bool true
          sudo defaults write "$ARD_PLIST" VNCPassword -string "VNCpass2025"
          
          # Step 3: Enable screen sharing in system preferences
          echo "Enabling screen sharing..."
          sudo defaults write /Library/Preferences/com.apple.RemoteDesktop.plist ARD_AllowRemoteAppleEvents -bool true
          
          # Step 4: Grant screen recording permissions via tccutil
          echo "Granting screen recording permissions..."
          sudo tccutil reset ScreenCapture com.apple.RemoteManagement.Agent 2>/dev/null || true
          sudo tccutil grant ScreenCapture com.apple.RemoteManagement.Agent 2>/dev/null || true
          
          # Step 5: Activate ARD using kickstart
          echo "Activating ARD..."
          KICKSTART="/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart"
          sudo "$KICKSTART" -activate -configure -access -on -users _Unknown -privs -all -restart -agent 2>&1 | grep -v "Error" || true
          
          # Step 6: Enable VNC legacy mode via kickstart  
          echo "Enabling VNC legacy mode..."
          sudo "$KICKSTART" -configure -setvnclegacy -vnclegacy yes -restart -agent 2>&1 | grep -v "Error" || true
          
          # Step 7: Set VNC password via kickstart
          echo "Setting VNC password..."
          sudo "$KICKSTART" -configure -clientopts -setmenuextra -menuextra yes -setvncpw -vncpw VNCpass2025 -restart -agent 2>&1 | grep -v "Error" || true
          
          # Step 8: Start services
          echo "Starting ARD services..."
          sudo launchctl load /System/Library/LaunchDaemons/com.apple.RemoteManagement.launchd 2>/dev/null || true
          sudo launchctl start com.apple.RemoteManagement.Agent.launchd 2>/dev/null || true
          
          # Step 9: Aggressive wait and verify
          echo "Waiting for VNC to initialize (25 seconds)..."
          for i in {1..5}; do
            sleep 5
            if netstat -an 2>/dev/null | grep -q ":5900.*LISTEN"; then
              echo "VNC is LISTENING after $((i*5)) seconds"
              break
            fi
            echo "Attempt $i: VNC not yet listening, waiting..."
          done
          
          # Step 10: Verify configuration
          echo "Verifying configuration..."
          echo "ARD plist contents:"
          defaults read "$ARD_PLIST" 2>/dev/null | grep -E "(VNC|ARD)" || echo "(plist entries)"
          echo "Port 5900 status:"
          netstat -an | grep 5900 || echo "Port 5900 check attempted"
          echo "ARD processes:"
          ps aux | grep -i "[r]emotemanagement" || echo "No processes"
          echo ""

      - name: Display VNC Connection Info
        run: |
          echo ""
          echo "================================="
          echo "VNC CONNECTION INFORMATION"
          echo "================================="
          TAILSCALE_IP=$(tailscale ip -4)
          echo "Tailscale IP: $TAILSCALE_IP"
          echo "VNC Port: 5900"
          echo "VNC Password: VNCpass2025"
          echo "Connection String: $TAILSCALE_IP:5900"
          echo "VNC Mode: Legacy"
          echo "================================="
          echo ""

      - name: Keep VNC Running - 6 Hour Monitoring
        run: |
          echo "Starting 6-hour VNC monitoring loop..."
          KICKSTART="/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart"
          for minute in {1..360}; do
            echo "[$minute/360] Checking VNC status..."
            if netstat -an 2>/dev/null | grep -q ":5900.*LISTEN"; then
              echo "✓ VNC LISTENING at $(date)"
            else
              echo "✗ VNC NOT LISTENING - attempting restart at $(date)"
              sudo launchctl stop com.apple.RemoteManagement.Agent.launchd 2>/dev/null || true
              sleep 2
              sudo "$KICKSTART" -configure -setvnclegacy -vnclegacy yes -restart -agent 2>/dev/null || true
              sleep 3
              sudo launchctl start com.apple.RemoteManagement.Agent.launchd 2>/dev/null || true
              sleep 5
            fi
            sleep 60
          done
