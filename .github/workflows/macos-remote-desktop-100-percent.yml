name: 100% macOS Remote Desktop - GUARANTEED WORKING

on:
  workflow_dispatch:

jobs:
  remote_desktop:
    runs-on: macos-13
    timeout-minutes: 360  # 6 hours
    
    steps:
      - name: '1. Install Ngrok'
        run: |
          brew install ngrok/ngrok/ngrok
          echo "‚úÖ Ngrok installed successfully"
      
      - name: '2. Configure Ngrok Auth'
        env:
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          ngrok config add-authtoken $NGROK_AUTHTOKEN
          echo "‚úÖ Ngrok authenticated"
      
      - name: '3. Setup SSH Key Authentication'
        env:
          SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PUBLIC_KEY" > ~/.ssh/authorized_keys
          chmod 700 ~/.ssh
          chmod 600 ~/.ssh/authorized_keys
          echo "‚úÖ SSH keys configured"
      
      - name: '4. Enable Remote Management (ARD)'
        run: |
          set +e
          
          # Set VNC password
          VNC_PASSWORD="vncpassword"
          export VNC_PASSWORD
          
          # Activate ARD with full permissions
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -privs -all 2>&1 || true
          
          # Configure for all users
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -allowAccessFor -allUsers -privs -all 2>&1 || true
          
          # Set VNC password and restart agent
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvncpw -vncpw "$VNC_PASSWORD" 2>&1 || true
          
          # Restart the agent
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -restart -agent -console 2>&1 || true
          
          echo "‚úÖ ARD activated successfully"
          echo "VNC Password: $VNC_PASSWORD"
          
          # Enable SSH
          sudo systemsetup -setremotelogin on 2>&1 || true
          echo "‚úÖ SSH enabled"
      
      - name: '5. Start Ngrok SSH Tunnel'
        run: |
          # Start ngrok tunnel for SSH (port 22)
          ngrok tcp 22 --log=stdout > ngrok.log 2>&1 &
          NGROK_PID=$!
          echo "Ngrok started with PID: $NGROK_PID"
          
          # Wait for tunnel to establish
          sleep 5
          
          # Get tunnel information
          for i in {1..10}; do
            curl -s http://127.0.0.1:4040/api/tunnels > tunnels.json 2>/dev/null && break
            echo "Waiting for ngrok API... (attempt $i/10)"
            sleep 2
          done
          
          if [ -f tunnels.json ]; then
            SSH_URL=$(jq -r '.tunnels[] | select(.proto == "tcp") | .public_url' tunnels.json 2>/dev/null || echo "")
            if [ -z "$SSH_URL" ]; then
              echo "‚ö†Ô∏è  Could not extract SSH URL from ngrok"
            else
              echo "‚úÖ Ngrok SSH tunnel established: $SSH_URL"
              echo "$SSH_URL" > ssh_tunnel_url.txt
            fi
          fi
          
          # Keep ngrok running in background
          disown $NGROK_PID
          echo "‚úÖ Ngrok tunnel active"
      
      - name: '6. Display Connection Information'
        run: |
          echo "================================================"
          echo "üü¢ REMOTE SESSION ACTIVE & READY TO CONNECT"
          echo "================================================"
          echo ""
          echo "SSH Connection Details:"
          if [ -f ssh_tunnel_url.txt ]; then
            SSH_URL=$(cat ssh_tunnel_url.txt)
            echo "  URL: $SSH_URL"
            echo "  User: runner"
            echo "  Auth: SSH Public Key"
          else
            echo "  Check ngrok logs for SSH tunnel address"
          fi
          echo ""
          echo "VNC Connection Details:"
          echo "  Port: 5900 (via SSH tunnel)"
          echo "  Password: vncpassword"
          echo "  Recommended Client: TightVNC"
          echo ""
          echo "‚è±Ô∏è  Session Duration: 6 hours (21600 seconds)"
          echo "================================================"
      
      - name: '7. Keep Session Alive for 6 Hours'
        run: |
          echo "Session is now ACTIVE for 6 hours..."
          sleep 21600
