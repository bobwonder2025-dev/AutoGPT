name: 'ðŸ’» macOS Remote Desktop - 100% WORKING'
on:
  workflow_dispatch:
jobs:
  remote_session:
    runs-on: macos-13
    timeout-minutes: 360
    steps:
      - name: '1. Install Ngrok'
        run: brew install ngrok/ngrok/ngrok
      - name: '2. Configure Ngrok'
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: ngrok config add-authtoken $NGROK_AUTH_TOKEN
      - name: '3. SSH Key Setup'
        env:
          SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PUBLIC_KEY" > ~/.ssh/authorized_keys
          chmod 700 ~/.ssh
          chmod 600 ~/.ssh/authorized_keys
      - name: '4. Install TCC Profile'
        run: |
          cat << 'TCCEOF' > tcc_profile.mobileconfig
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>PayloadContent</key>
            <array>
              <dict>
                <key>PayloadDescription</key>
                <string>Grants screen capture and accessibility to ARDAgent</string>
                <key>PayloadDisplayName</key>
                <string>TCC Permissions</string>
                <key>PayloadIdentifier</key>
                <string>com.github.actions.tcc.1</string>
                <key>PayloadType</key>
                <string>com.apple.TCC.configuration-profile-policy</string>
                <key>PayloadUUID</key>
                <string>9E3F8029-1F76-49C1-A05E-B51A2C8F02C4</string>
                <key>PayloadVersion</key>
                <integer>1</integer>
                <key>Services</key>
                <dict>
                  <key>Accessibility</key>
                  <array>
                    <dict>
                      <key>Allowed</key>
                      <true/>
                      <key>CodeRequirement</key>
                      <string>identifier "com.apple.ARDAgent" and anchor apple</string>
                      <key>Identifier</key>
                      <string>com.apple.ARDAgent</string>
                      <key>IdentifierType</key>
                      <string>bundleID</string>
                    </dict>
                  </array>
                  <key>ScreenCapture</key>
                  <array>
                    <dict>
                      <key>Allowed</key>
                      <true/>
                      <key>CodeRequirement</key>
                      <string>identifier "com.apple.ARDAgent" and anchor apple</string>
                      <key>Identifier</key>
                      <string>com.apple.ARDAgent</string>
                      <key>IdentifierType</key>
                      <string>bundleID</string>
                    </dict>
                  </array>
                </dict>
              </dict>
            </array>
            <key>PayloadDisplayName</key>
            <string>GitHub Actions TCC Permissions</string>
            <key>PayloadIdentifier</key>
            <string>com.github.actions.tcc</string>
            <key>PayloadScope</key>
            <string>System</string>
            <key>PayloadType</key>
            <string>Configuration</string>
            <key>PayloadUUID</key>
            <string>4B1AAA67-A6AD-485A-8A6E-C5751C47020F</string>
            <key>PayloadVersion</key>
            <integer>1</integer>
          </dict>
          </plist>
          TCCEOF
          sudo profiles install -path=tcc_profile.mobileconfig 2>&1 || true
      - name: '5. Configure ARD VNC'
        run: |
          VNC_PASSWORD="vncpassword"
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -configure -allowAccessFor -allUsers -privs -all 2>&1 || true
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -configure -clientopts -setvnclegacy -vnclegacy yes 2>&1 || true
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -configure -clientopts -setvncpw -vncpw "$VNC_PASSWORD" 2>&1 || true
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -restart -agent -console 2>&1 || true
          echo "VNC Password: $VNC_PASSWORD"
      - name: '6. Start Ngrok SSH Tunnel'
        run: |
          ngrok tcp 22 --log=stdout > ngrok.log 2>&1 &
          sleep 15
          echo "âœ… Remote Session LIVE"
          curl -s http://127.0.0.1:4040/api/tunnels
      - name: '7. Keep Alive 6 Hours'
        run: sleep 21600
